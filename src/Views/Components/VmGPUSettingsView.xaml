<UserControl x:Class="ExHyperV.Views.Components.VmGPUSettingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:properties="clr-namespace:ExHyperV.Properties"
             xmlns:converters="clr-namespace:ExHyperV.Converters"
             xmlns:vm="clr-namespace:ExHyperV.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignHeight="850" d:DesignWidth="1000"
             d:DataContext="{d:DesignInstance vm:VirtualMachinesPageViewModel}">

    <UserControl.Resources>
        <converters:EqualityToVisibilityConverter x:Key="EqualityToVisibilityConverter" />
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>

        <!-- 品牌高亮样式 -->
        <Style x:Key="GpuBrandTextStyle" TargetType="TextBlock">
            <Setter Property="Foreground" Value="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding DataContext.SelectedVm.GpuName, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource EqualityToVisibilityConverter}, ConverterParameter=NVIDIA}" Value="Visible">
                    <Setter Property="Foreground" Value="#76B900"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- 标题栏 -->
            <RowDefinition Height="*"/>
            <!-- 列表区 -->
        </Grid.RowDefinitions>

        <!-- 1. 顶部标题栏 -->
        <Grid Grid.Row="0" Margin="0,0,0,24">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <ui:FontIcon Glyph="&#xF211;" FontFamily="{DynamicResource SegoeFluentIcons}" FontSize="24" Margin="0,0,12,0" 
                             Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                <TextBlock Text="显卡设置" FontSize="20" VerticalAlignment="Center" 
                           Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
            </StackPanel>

            <ui:Button Grid.Column="1" Content="添加显卡" Icon="{ui:SymbolIcon Symbol=Add24}" 
                       Appearance="Primary" Margin="0,0,8,0" Padding="16,6"
                       Command="{Binding GoToAddGpuCommand}"/>

            <ui:Button Grid.Column="2" Appearance="Transparent" Padding="8" Command="{Binding GoBackCommand}">
                <ui:SymbolIcon Symbol="ArrowLeft24" FontSize="18"/>
            </ui:Button>
        </Grid>

        <!-- 2. 显卡列表区域 (直接放置卡片) -->
        <Grid Grid.Row="1">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <StackPanel>
                    <ItemsControl ItemsSource="{Binding SelectedVm.GPUs}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <!-- 每一项都是一个独立的独立卡片 -->
                                <ui:Card Margin="0,0,0,12" Padding="16">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <ui:FontIcon Grid.Column="0" Glyph="&#xF211;" FontFamily="{DynamicResource SegoeFluentIcons}" 
                                                     FontSize="22" Margin="4,0,20,0" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>

                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <!-- 实例路径 -->
                                            <TextBlock Text="{Binding Value}" FontSize="14" FontWeight="Medium" 
                                                       Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}" TextTrimming="CharacterEllipsis"/>

                                            <StackPanel Orientation="Horizontal" Margin="0,4,0,0" Opacity="0.7">
                                                <TextBlock Text="ID: " FontSize="11" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                                <TextBlock Text="{Binding Key}" FontSize="11" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,16,0"/>

                                                <TextBlock Text="物理型号: " FontSize="11" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                                <TextBlock Text="{Binding DataContext.SelectedVm.GpuName, RelativeSource={RelativeSource AncestorType=UserControl}}" 
                                                           FontSize="11" Style="{StaticResource GpuBrandTextStyle}"/>
                                            </StackPanel>
                                        </StackPanel>

                                        <ui:Button Grid.Column="2" Content="移除" Appearance="Danger" 
                                                   Icon="{ui:SymbolIcon Symbol=Delete24}" Padding="12,6"
                                                   Command="{Binding DataContext.RemoveGpuCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                   CommandParameter="{Binding Key}"/>
                                    </Grid>
                                </ui:Card>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- 空状态提示 -->
                    <StackPanel Visibility="{Binding SelectedVm.GPUs.Count, Converter={StaticResource EqualityToVisibilityConverter}, ConverterParameter=0}"
                                HorizontalAlignment="Center" Margin="0,100,0,0">
                        <TextBlock Text="无" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" 
                                   Opacity="0.4" FontSize="14" HorizontalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>
            </ScrollViewer>
        </Grid>
    </Grid>
</UserControl>