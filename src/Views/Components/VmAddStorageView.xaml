<UserControl x:Class="ExHyperV.Views.Components.VmAddStorageView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             xmlns:converters="clr-namespace:ExHyperV.Converters"
             xmlns:properties="clr-namespace:ExHyperV.Properties"
             xmlns:vm="clr-namespace:ExHyperV.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignHeight="950" d:DesignWidth="600"
             d:DataContext="{d:DesignInstance vm:VirtualMachinesPageViewModel}">

    <UserControl.Resources>
        <converters:EqualityConverter x:Key="EqualityConverter" />
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:EqualityToVisibilityConverter x:Key="EqualityToVisibilityConverter" />

        <Style TargetType="ui:ToggleSwitch" BasedOn="{StaticResource {x:Type ui:ToggleSwitch}}">
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <Grid Grid.Row="0" Margin="24,24,24,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <TextBlock Text="{x:Static properties:Resources.AddDisk_WindowTitle}" 
                       FontSize="24" FontWeight="SemiBold" 
                       VerticalAlignment="Center" 
                       Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>

              <ui:Button Grid.Column="1" Appearance="Transparent" Icon="{ui:SymbolIcon Symbol=ArrowLeft24}" 
                     Padding="8" Command="{Binding GoBackCommand}"/>
        </Grid>

        <ScrollViewer Grid.Row="1" Padding="24,0,24,24" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                <TextBlock Text="{x:Static properties:Resources.AddDisk_SlotConfig}" 
                           FontSize="14" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,8"/>

                <Border Background="{ui:ThemeResource CardBackgroundFillColorDefaultBrush}" 
                        BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}" 
                        BorderThickness="1" CornerRadius="8" Padding="0" Margin="0,0,0,24">
                    <StackPanel>
                        <Grid Margin="16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel VerticalAlignment="Center">
                                <TextBlock Text="{x:Static properties:Resources.AddDisk_AutoAssign}" 
                                           FontSize="14" FontWeight="Medium" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}" Margin="0,0,0,2"/>
                                <TextBlock Text="自动选择可用的控制器位置" 
                                           FontSize="12" Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}"/>
                            </StackPanel>
                            <ui:ToggleSwitch Grid.Column="1" IsChecked="{Binding AutoAssign}" />
                        </Grid>

                        <StackPanel>
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding AutoAssign}" Value="False">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>
                            <Rectangle Height="1" Fill="{ui:ThemeResource CardStrokeColorDefaultBrush}" Margin="16,0"/>
                            <Grid Margin="16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="12"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="12"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="{x:Static properties:Resources.AddDisk_Interface}" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                    <ComboBox ItemsSource="{Binding AvailableControllerTypes}" SelectedItem="{Binding SelectedControllerType}" HorizontalAlignment="Stretch"/>
                                </StackPanel>
                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="{x:Static properties:Resources.AddDisk_Number}" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                    <ComboBox ItemsSource="{Binding AvailableControllerNumbers}" SelectedItem="{Binding SelectedControllerNumber}" HorizontalAlignment="Stretch"/>
                                </StackPanel>
                                <StackPanel Grid.Column="4">
                                    <TextBlock Text="{x:Static properties:Resources.AddDisk_Location}" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                    <ComboBox ItemsSource="{Binding AvailableLocations}" SelectedItem="{Binding SelectedLocation, Mode=TwoWay}" HorizontalAlignment="Stretch"/>
                                </StackPanel>
                            </Grid>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <TextBlock Text="基本设置" FontSize="14" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,8"/>

                <Border Background="{ui:ThemeResource CardBackgroundFillColorDefaultBrush}" 
                        BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}" 
                        BorderThickness="1" CornerRadius="8" Padding="16" Margin="0,0,0,24">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="24"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="{x:Static properties:Resources.AddDisk_Type}" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,10"/>
                            <StackPanel Orientation="Vertical" >
                                <RadioButton Content="{x:Static properties:Resources.AddDisk_Type_HardDisk}" 
                                             IsChecked="{Binding DeviceType, Converter={StaticResource EqualityConverter}, ConverterParameter=HardDisk}"
                                             Margin="0,0,0,8"/>
                                <RadioButton Content="{x:Static properties:Resources.AddDisk_Type_OpticalDrive}" 
                                             IsChecked="{Binding DeviceType, Converter={StaticResource EqualityConverter}, ConverterParameter=DvdDrive}"/>
                            </StackPanel>
                        </StackPanel>

                        <StackPanel Grid.Column="2">
                            <TextBlock Text="{x:Static properties:Resources.AddDisk_Source}" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,10"/>
                            <StackPanel Orientation="Vertical" >
                                <RadioButton Content="{x:Static properties:Resources.AddDisk_Source_VirtualFile}" 
                                             IsChecked="{Binding IsPhysicalSource, Converter={StaticResource InverseBooleanConverter}}"
                                             Margin="0,0,0,8"/>
                                <RadioButton Content="{x:Static properties:Resources.AddDisk_Source_Physical}" 
                                             IsChecked="{Binding IsPhysicalSource}"/>
                            </StackPanel>
                        </StackPanel>
                    </Grid>
                </Border>

                <TextBlock Text="媒体配置" FontSize="14" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,8"/>

                <Border Background="{ui:ThemeResource CardBackgroundFillColorDefaultBrush}" 
                        BorderBrush="{ui:ThemeResource CardStrokeColorDefaultBrush}" 
                        BorderThickness="1" CornerRadius="8" Padding="0" Margin="0,0,0,24">
                    <Grid MinHeight="80">
                        <StackPanel>
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsPhysicalSource}" Value="False">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>

                            <Grid Margin="16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel VerticalAlignment="Center">
                                    <TextBlock Text="{x:Static properties:Resources.AddDisk_New}" 
                                               FontSize="14" FontWeight="Medium" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}" Margin="0,0,0,2"/>
                                    <TextBlock Text="创建一个新的虚拟媒体文件" 
                                               FontSize="12" Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}"/>
                                </StackPanel>
                                <ui:ToggleSwitch Grid.Column="1" IsChecked="{Binding IsNewDisk}" />
                            </Grid>

                            <Rectangle Height="1" Fill="{ui:ThemeResource CardStrokeColorDefaultBrush}" Margin="16,0"/>

                            <Grid Margin="16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <ui:TextBox Text="{Binding FilePath, UpdateSourceTrigger=PropertyChanged}" 
                                            PlaceholderText="{Binding FilePathPlaceholder}" VerticalAlignment="Center"/>
                                <ui:Button Grid.Column="1" 
           Content="{Binding BrowseButtonText}" 
           Margin="8,0,0,0" Width="80" 
           Command="{Binding BrowseFileCommand}"/>
                            </Grid>

                            <StackPanel>
                                <StackPanel.Style>
                                    <Style TargetType="StackPanel">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding IsNewDisk}" Value="True"/>
                                                    <Condition Binding="{Binding DeviceType}" Value="HardDisk"/>
                                                </MultiDataTrigger.Conditions>
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </MultiDataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </StackPanel.Style>

                                <Rectangle Height="1" Fill="{ui:ThemeResource CardStrokeColorDefaultBrush}" Margin="16,0"/>

                                <Grid Margin="16">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="12"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="{x:Static properties:Resources.AddDisk_CapacityGB}" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                        <ComboBox ItemsSource="{Binding NewDiskSizePresets}" Text="{Binding NewDiskSize, Mode=TwoWay}" IsEditable="True" HorizontalAlignment="Stretch">
                                            <ComboBox.Style>
                                                <Style TargetType="ComboBox" BasedOn="{StaticResource {x:Type ComboBox}}">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding SelectedVhdType}" Value="Differencing">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ComboBox.Style>
                                        </ComboBox>
                                    </StackPanel>

                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="{x:Static properties:Resources.AddDisk_DiskType}" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                        <ComboBox SelectedValuePath="Tag" SelectedValue="{Binding SelectedVhdType}" HorizontalAlignment="Stretch">
                                            <ComboBoxItem Content="{x:Static properties:Resources.AddDisk_VhdType_Dynamic}" Tag="Dynamic"/>
                                            <ComboBoxItem Content="{x:Static properties:Resources.AddDisk_VhdType_Fixed}" Tag="Fixed"/>
                                            <ComboBoxItem Content="{x:Static properties:Resources.AddDisk_VhdType_Differencing}" Tag="Differencing"/>
                                        </ComboBox>
                                    </StackPanel>
                                </Grid>

                                <Grid Margin="16,0,16,16">
                                    <Grid.Style>
                                        <Style TargetType="Grid">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedVhdType}" Value="Differencing">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Grid.Style>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <ui:TextBox Text="{Binding ParentPath}" PlaceholderText="{x:Static properties:Resources.AddDisk_Placeholder_ParentPath}" VerticalAlignment="Center"/>
                                    <ui:Button Grid.Column="1" Content="{x:Static properties:Resources.Common_Browse}" Margin="8,0,0,0" Width="80" Command="{Binding BrowseParentFileCommand}"/>
                                </Grid>

                                <Grid Margin="16,0,16,16">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="12"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="{x:Static properties:Resources.AddDisk_SectorFormat}" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                        <ComboBox SelectedValue="{Binding SectorFormat}" SelectedValuePath="Tag" HorizontalAlignment="Stretch">
                                            <ComboBox.Style>
                                                <Style TargetType="ComboBox" BasedOn="{StaticResource {x:Type ComboBox}}">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding SelectedVhdType}" Value="Differencing">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ComboBox.Style>
                                            <ComboBoxItem Content="{x:Static properties:Resources.Common_Default}" Tag="Default"/>
                                            <ComboBoxItem Content="512n" Tag="512n"/>
                                            <ComboBoxItem Content="512e" Tag="512e"/>
                                            <ComboBoxItem Content="4Kn" Tag="4kn"/>
                                        </ComboBox>
                                    </StackPanel>

                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="{x:Static properties:Resources.AddDisk_BlockSize}" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                        <ComboBox SelectedValue="{Binding BlockSize, Mode=TwoWay}" SelectedValuePath="Tag" HorizontalAlignment="Stretch">
                                            <ComboBox.Style>
                                                <Style TargetType="ComboBox" BasedOn="{StaticResource {x:Type ComboBox}}">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding SelectedVhdType}" Value="Differencing">
                                                            <Setter Property="IsEnabled" Value="False"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ComboBox.Style>
                                            <ComboBoxItem Content="{x:Static properties:Resources.Common_Default}" Tag="Default"/>
                                            <ComboBoxItem Content="1MB" Tag="1048576"/>
                                            <ComboBoxItem Content="2MB" Tag="2097152"/>
                                            <ComboBoxItem Content="4MB" Tag="4194304"/>
                                            <ComboBoxItem Content="8MB" Tag="8388608"/>
                                            <ComboBoxItem Content="16MB" Tag="16777216"/>
                                            <ComboBoxItem Content="32MB" Tag="33554432"/>
                                            <ComboBoxItem Content="64MB" Tag="67108864"/>
                                            <ComboBoxItem Content="128MB" Tag="134217728"/>
                                            <ComboBoxItem Content="256MB" Tag="268435456"/>
                                        </ComboBox>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>

                            <StackPanel>
                                <StackPanel.Style>
                                    <Style TargetType="StackPanel">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <MultiDataTrigger>
                                                <MultiDataTrigger.Conditions>
                                                    <Condition Binding="{Binding IsNewDisk}" Value="True"/>
                                                    <Condition Binding="{Binding DeviceType}" Value="DvdDrive"/>
                                                </MultiDataTrigger.Conditions>
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </MultiDataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </StackPanel.Style>

                                <Rectangle Height="1" Fill="{ui:ThemeResource CardStrokeColorDefaultBrush}" Margin="16,0"/>

                                <Grid Margin="16">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="{x:Static properties:Resources.AddDisk_FileContent}" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                        <ui:TextBox Text="{Binding IsoSourceFolderPath, UpdateSourceTrigger=PropertyChanged}" PlaceholderText="{x:Static properties:Resources.AddDisk_Placeholder_PackageFolder}" VerticalAlignment="Center"/>
                                    </StackPanel>
                                    <ui:Button Grid.Column="1" Content="{x:Static properties:Resources.Common_Select}" Margin="8,25,0,0" Command="{Binding BrowseFolderCommand}"/>
                                </Grid>

                                <StackPanel Margin="16,0,16,16">
                                    <TextBlock Text="{x:Static properties:Resources.AddDisk_VolumeLabel}" FontSize="12" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="0,0,0,6"/>
                                    <ui:TextBox Text="{Binding IsoVolumeLabel, UpdateSourceTrigger=PropertyChanged}" PlaceholderText="{x:Static properties:Resources.AddDisk_Placeholder_VolumeLabel}" HorizontalAlignment="Stretch"/>
                                    <TextBlock Text="{x:Static properties:Resources.AddDisk_Info_IsoLimits}" FontSize="12" Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}" Margin="2,6,0,0"/>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>

                        <Grid>
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsPhysicalSource}" Value="True">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>

                            <TextBlock Text="{x:Static properties:Resources.AddDisk_NoAvailablePhysical}" 
                                       HorizontalAlignment="Center" VerticalAlignment="Center" Opacity="0.5"
                                       Visibility="{Binding HostDisks.Count, Converter={StaticResource EqualityToVisibilityConverter}, ConverterParameter=0}"/>

                            <ui:ListView ItemsSource="{Binding HostDisks}" SelectedItem="{Binding SelectedPhysicalDisk}" 
                                         Margin="4" BorderThickness="0" Background="Transparent">
                                <ui:ListView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="8,6">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <ui:FontIcon Glyph="&#xEDA2;" FontFamily="{StaticResource SegoeFluentIcons}" FontSize="24" VerticalAlignment="Center" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                            <StackPanel Grid.Column="1" Margin="16,0,0,0">
                                                <TextBlock Text="{Binding FriendlyName}" FontWeight="Medium" Foreground="{ui:ThemeResource TextFillColorPrimaryBrush}"/>
                                                <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                                    <TextBlock Text="{x:Static properties:Resources.Common_Disk}" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                                    <TextBlock Text="{Binding Number}" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}" Margin="4,0,0,0"/>
                                                    <TextBlock Text=" | " Foreground="{ui:ThemeResource TextFillColorTertiaryBrush}" Margin="8,0"/>
                                                    <TextBlock Text="{Binding SizeGB, StringFormat='{}{0:F2} GB'}" Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"/>
                                                </StackPanel>
                                            </StackPanel>
                                        </Grid>
                                    </DataTemplate>
                                </ui:ListView.ItemTemplate>
                            </ui:ListView>
                        </Grid>
                    </Grid>
                </Border>

                <Grid Margin="0,0,0,0">
                    <ui:Button Content="{x:Static properties:Resources.sure}" Appearance="Primary" Width="120" HorizontalAlignment="Right"
                               Command="{Binding ConfirmAddStorageCommand}"/>
                </Grid>

            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>