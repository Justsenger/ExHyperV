<Page x:Class="ExHyperV.Views.Pages.CpuPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
      xmlns:converters="clr-namespace:ExHyperV.Converters"
      xmlns:vm="clr-namespace:ExHyperV.ViewModels"
      Title="CpuPage"
      d:DataContext="{d:DesignInstance vm:CpuPageViewModel, IsDesignTimeCreatable=True}"
      mc:Ignorable="d">

    <Page.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
            
        <!-- 找回特效：精细网格笔刷 -->
        <DrawingBrush x:Key="FineGridBrush" 
                      Viewport="0,0,10,10" ViewportUnits="Absolute" 
                      TileMode="Tile">
            <DrawingBrush.Drawing>
                <GeometryDrawing>
                    <GeometryDrawing.Geometry>
                        <RectangleGeometry Rect="0,0,10,10"/>
                    </GeometryDrawing.Geometry>
                    <!-- 极淡的灰色网格，适应深浅主题 -->
                    <GeometryDrawing.Pen>
                        <Pen Brush="#15888888" Thickness="1"/>
                    </GeometryDrawing.Pen>
                </GeometryDrawing>
            </DrawingBrush.Drawing>
        </DrawingBrush>
    </Page.Resources>

    <Grid>
        <StackPanel Margin="10,0,10,10">

            <!-- 标题栏：改回 ui:Card，自动适配主题颜色 -->
            <Grid Margin="0,5,0,0">
                <ui:Card BorderThickness="1" Padding="10">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                            <ui:FontIcon Glyph="&#xE9D9;" FontSize="20" FontFamily="{DynamicResource SegoeFluentIcons}"/>
                            <TextBlock Text="CPU 负载监控" FontSize="16" FontWeight="SemiBold" VerticalAlignment="Center" Margin="10,0,0,0"/>
                        </StackPanel>

                        <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                            <TextBlock Text="更新速度：" VerticalAlignment="Center" Margin="0,0,10,0" Opacity="0.8"/>
                            <ComboBox SelectedIndex="{Binding SelectedSpeedIndex}" Width="120">
                                <ComboBoxItem Content="快 (1s)"/>
                                <ComboBoxItem Content="常规 (2s)"/>
                                <ComboBoxItem Content="慢 (5s)"/>
                                <ComboBoxItem Content="暂停"/>
                            </ComboBox>
                        </StackPanel>
                    </Grid>
                </ui:Card>
            </Grid>

            <!-- 虚拟机列表 -->
            <ItemsControl ItemsSource="{Binding VmList}" Margin="0,5,0,0">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <!-- 容器：改回 ui:Card，解决背景色突兀的问题 -->
                        <ui:Card Margin="0,5,0,0" Padding="15">
                            <StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <ui:FontIcon FontFamily="{DynamicResource SegoeFluentIcons}" Glyph="&#xE977;" FontSize="18" Margin="0,0,10,0"/>
                                    <TextBlock Text="{Binding Name}" FontSize="16" FontWeight="SemiBold"/>
                                </StackPanel>

                                <!-- 核心矩阵 -->
                                <ItemsControl ItemsSource="{Binding Cores}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <UniformGrid Columns="{Binding Columns}" FirstColumn="0"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>

                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Grid Margin="3" Height="65">
                                                <!-- 内部核心：保持 Border 以节省性能，但颜色改为通用半透明，不冲突 -->
                                                <Border CornerRadius="4" BorderThickness="1" BorderBrush="#1A888888" Background="#08FFFFFF" ClipToBounds="True">
                                                    <Grid>
                                                        <!-- 1. 找回特效：网格背景 -->
                                                        <Rectangle Fill="{StaticResource FineGridBrush}"/>


                                                        <!-- 2. 波形图 -->
                                                        <Viewbox Stretch="Fill">
                                                            <Grid Width="100" Height="100">
                                                                <Polygon Points="{Binding HistoryPoints}"
                                                                         Fill="#66117DBB"/>
                                                                <Polyline Points="{Binding HistoryPoints}"
                                                                          Stroke="#FF54C7FC"
                                                                          StrokeThickness="1.5"/>
                                                            </Grid>
                                                        </Viewbox>

                                                        <!-- ID -->
                                                        <TextBlock Text="{Binding CoreId}" 
                                                                   FontSize="10" 
                                                                   Opacity="0.6" 
                                                                   Margin="5,2,0,0"
                                                                   HorizontalAlignment="Left" 
                                                                   VerticalAlignment="Top"
                                                                   Foreground="{DynamicResource TextFillColorSecondaryBrush}"/>

                                                        <!-- 数值 -->
                                                        <TextBlock Text="{Binding Usage, StringFormat='{}{0:N1}%'}" 
                                                                   FontSize="16" 
                                                                   FontWeight="Bold" 
                                                                   HorizontalAlignment="Center" 
                                                                   VerticalAlignment="Center"
                                                                   Foreground="{DynamicResource TextFillColorPrimaryBrush}">
                                                        </TextBlock>
                                                    </Grid>
                                                </Border>
                                            </Grid>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </ui:Card>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </StackPanel>
        <ProgressBar Panel.ZIndex="1" 
                 VerticalAlignment="Top" 
                 Height="4" 
                 IsIndeterminate="True"
                 Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"/>
    </Grid>

</Page>