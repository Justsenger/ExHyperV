<Page
    x:Class="ExHyperV.Views.Pages.MemoryPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:viewmodels="clr-namespace:ExHyperV.ViewModels"
    xmlns:converters="clr-namespace:ExHyperV.Converters"
    Title="MemoryPage"
    d:DataContext="{d:DesignInstance Type=viewmodels:MemoryPageViewModel, IsDesignTimeCreatable=True}"
    mc:Ignorable="d">

    <Page.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:MemoryImagePathConverter x:Key="MemoryImagePathConverter"/>
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        
    </Page.Resources>

    <Grid>
        <StackPanel Margin="10,0,10,20" IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}">
            <!-- 已安装内存部分 -->
            <ui:Card Padding="12" Margin="10,10,10,0">
                <StackPanel Orientation="Horizontal">
                    <ui:FontIcon FontSize="24" FontFamily="{DynamicResource SegoeFluentIcons}" Glyph="&#xEEA0;"/>
                    <TextBlock Text="已安装内存" Margin="10,0,0,0" FontSize="16" VerticalAlignment="Center"/>
                </StackPanel>
            </ui:Card>
            <ItemsControl ItemsSource="{Binding MemoryBankGroups}" Margin="30,0,10,0">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type viewmodels:MemoryBankGroupViewModel}">
                        <Border BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="4" Margin="0,4,0,0" Padding="8">
                            <ItemsControl ItemsSource="{Binding MemoryModulesInGroup}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="{x:Type viewmodels:HostMemoryViewModel}">
                                        <ui:CardExpander Margin="0" Padding="8">
                                            <ui:CardExpander.Header>
                                                <Grid MinHeight="32">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="96"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <Image Grid.Column="0" Source="{Binding Manufacturer, Converter={StaticResource MemoryImagePathConverter}}" 
                                                           MaxHeight="32" 
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"
                                                           RenderOptions.BitmapScalingMode="HighQuality"
                                                           Margin="0,0,10,0"
                                                           SnapsToDevicePixels="True"/>
                                                    <TextBlock Grid.Column="1" Text="{Binding DisplayName}" FontSize="16" VerticalAlignment="Center"/>
                                                </Grid>
                                            </ui:CardExpander.Header>
                                            <Grid Margin="50,0,0,0">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="30"/>
                                                    <RowDefinition Height="30"/>
                                                    <RowDefinition Height="30"/>
                                                    <RowDefinition Height="30"/>
                                                </Grid.RowDefinitions>
                                                <TextBlock Grid.Row="0" Grid.Column="0" Text="厂商" FontSize="16" VerticalAlignment="Center"/>
                                                <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding Manufacturer}" Margin="25,0,0,0" FontSize="16" VerticalAlignment="Center"/>
                                                <TextBlock Grid.Row="0" Grid.Column="2" Text="型号" Margin="40,0,0,0" FontSize="16" VerticalAlignment="Center"/>
                                                <TextBlock Grid.Row="0" Grid.Column="3" Text="{Binding PartNumber}" Margin="25,0,0,0" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" FontSize="16" VerticalAlignment="Center"/>
                                                <TextBlock Grid.Row="1" Grid.Column="0" Text="内存组" FontSize="16" VerticalAlignment="Center"/>
                                                <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding BankLabel}" Margin="25,0,0,0" FontSize="16" VerticalAlignment="Center"/>
                                                <TextBlock Grid.Row="1" Grid.Column="2" Text="插槽位置" Margin="40,0,0,0" FontSize="16" VerticalAlignment="Center"/>
                                                <TextBlock Grid.Row="1" Grid.Column="3" Text="{Binding DeviceLocator}" Margin="25,0,0,0" TextWrapping="NoWrap" TextTrimming="CharacterEllipsis" FontSize="16" VerticalAlignment="Center"/>
                                                <TextBlock Grid.Row="2" Grid.Column="0" Text="类型" FontSize="16" VerticalAlignment="Center"/>
                                                <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding MemoryType}" Margin="25,0,0,0" FontSize="16" VerticalAlignment="Center"/>
                                                <TextBlock Grid.Row="2" Grid.Column="2" Text="容量" Margin="40,0,0,0" FontSize="16" VerticalAlignment="Center"/>
                                                <TextBlock Grid.Row="2" Grid.Column="3" Text="{Binding Capacity}" Margin="25,0,0,0" FontSize="16" VerticalAlignment="Center"/>
                                                <TextBlock Grid.Row="3" Grid.Column="0" Text="额定速度" FontSize="16" VerticalAlignment="Center"/>
                                                <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding DeclaredSpeed}" Margin="25,0,0,0" FontSize="16" VerticalAlignment="Center"/>
                                                <TextBlock Grid.Row="3" Grid.Column="2" Text="运行速度" Margin="40,0,0,0" FontSize="16" VerticalAlignment="Center"/>
                                                <TextBlock Grid.Row="3" Grid.Column="3" Text="{Binding ConfiguredSpeed}" Margin="25,0,0,0" FontSize="16" VerticalAlignment="Center"/>
                                            </Grid>
                                        </ui:CardExpander>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- 虚拟机内存部分 -->
            <ui:Card Padding="12" Margin="10,15,10,0">
                <Grid>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <ui:FontIcon FontSize="24" FontFamily="{DynamicResource SegoeFluentIcons}" Glyph="&#xE97C;"/>
                        <TextBlock Text="虚拟机内存" Margin="10,0,0,0" FontSize="16" VerticalAlignment="Center"/>
                    </StackPanel>
                    <ui:Button Command="{Binding RefreshVmDataCommand}" HorizontalAlignment="Right" Content="刷新" Appearance="Secondary"/>
                </Grid>
            </ui:Card>
            <ItemsControl ItemsSource="{Binding VirtualMachinesMemory}" Margin="30,0,10,0">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type viewmodels:VirtualMachineMemoryViewModel}">
                        <ui:CardExpander Margin="0,5,0,0" Padding="8">
                            <ui:CardExpander.Header>
                                <StackPanel Orientation="Horizontal" MinHeight="32">
                                    <ui:FontIcon FontFamily="{DynamicResource SegoeFluentIcons}" 
                                                Glyph="{Binding VmIconGlyph}" 
                                                Margin="0,0,10,0" 
                                                VerticalAlignment="Center"
                                                FontSize="20"/>
                                    <TextBlock Text="{Binding VMName}" FontSize="16" VerticalAlignment="Center"/>
                                </StackPanel>
                            </ui:CardExpander.Header>
                            <Grid Margin="20,10,20,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <StackPanel Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" Margin="0,0,30,15">
                                    <TextBlock Text="启动 RAM" FontSize="16" FontWeight="SemiBold"/>
                                    <TextBlock Text="指定启动此虚拟机所需的初始内存量" Foreground="{DynamicResource TextFillColorSecondaryBrush}" FontSize="12" Margin="0,2,0,0"/>
                                </StackPanel>
                                <Grid Grid.Row="0" Grid.Column="1" VerticalAlignment="Center" Margin="0,0,0,15">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <ComboBox Text="{Binding StartupMB, UpdateSourceTrigger=PropertyChanged}" IsEditable="True">
                                        <ComboBoxItem Content="512"/>
                                        <ComboBoxItem Content="1024"/>
                                        <ComboBoxItem Content="2048"/>
                                        <ComboBoxItem Content="3072"/>
                                        <ComboBoxItem Content="4096"/>
                                        <ComboBoxItem Content="6144"/>
                                        <ComboBoxItem Content="8192"/>
                                        <ComboBoxItem Content="16384"/>
                                        <ComboBoxItem Content="24576"/>
                                        <ComboBoxItem Content="32768"/>
                                        <ComboBoxItem Content="65536"/>
                                    </ComboBox>
                                    <TextBlock Grid.Column="1" Text="MB" VerticalAlignment="Center" FontSize="14" Margin="10,0,0,0"/>
                                </Grid>

                                <CheckBox Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Content="启用动态内存" IsChecked="{Binding DynamicMemoryEnabled}" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,10"/>

                                <Grid Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="2" IsEnabled="{Binding DynamicMemoryEnabled}" Margin="20,0,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" MinWidth="100"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <StackPanel Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" Margin="0,0,30,15">
                                        <TextBlock Text="最小 RAM" FontSize="16" FontWeight="SemiBold"/>
                                        <TextBlock Text="虚拟机可收缩到的最小内存" Foreground="{DynamicResource TextFillColorSecondaryBrush}" FontSize="12" Margin="0,2,0,0" TextWrapping="Wrap"/>
                                    </StackPanel>
                                    <Grid Grid.Row="0" Grid.Column="1" VerticalAlignment="Center" Margin="0,0,0,15">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <ComboBox Text="{Binding MinimumMB, UpdateSourceTrigger=PropertyChanged}" IsEditable="True">
                                            <ComboBoxItem Content="512"/>
                                            <ComboBoxItem Content="1024"/>
                                            <ComboBoxItem Content="2048"/>
                                            <ComboBoxItem Content="3072"/>
                                            <ComboBoxItem Content="4096"/>
                                            <ComboBoxItem Content="6144"/>
                                            <ComboBoxItem Content="8192"/>
                                            <ComboBoxItem Content="16384"/>
                                            <ComboBoxItem Content="24576"/>
                                            <ComboBoxItem Content="32768"/>
                                            <ComboBoxItem Content="65536"/>
                                        </ComboBox>
                                        <TextBlock Grid.Column="1" Text="MB" VerticalAlignment="Center" FontSize="14" Margin="10,0,0,0"/>
                                    </Grid>
                                    <StackPanel Grid.Row="1" Grid.Column="0" VerticalAlignment="Center" Margin="0,0,30,15">
                                        <TextBlock Text="最大 RAM" FontSize="16" FontWeight="SemiBold"/>
                                        <TextBlock Text="虚拟机可扩展到的最大内存" Foreground="{DynamicResource TextFillColorSecondaryBrush}" FontSize="12" Margin="0,2,0,0" TextWrapping="Wrap"/>
                                    </StackPanel>
                                    <Grid Grid.Row="1" Grid.Column="1" VerticalAlignment="Center" Margin="0,0,0,15">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <ui:TextBox Text="{Binding MaximumMB, UpdateSourceTrigger=PropertyChanged}" />
                                        <TextBlock Grid.Column="1" Text="MB" VerticalAlignment="Center" FontSize="14" Margin="10,0,0,0"/>
                                    </Grid>
                                    <StackPanel Grid.Row="2" Grid.Column="0" VerticalAlignment="Center" Margin="0,0,30,0">
                                        <TextBlock Text="内存缓冲区" FontSize="16" FontWeight="SemiBold"/>
                                        <TextBlock Text="分配量 = (100% + 缓冲区%) * 需求量" Foreground="{DynamicResource TextFillColorSecondaryBrush}" FontSize="12" Margin="0,2,0,0" TextWrapping="Wrap"/>
                                    </StackPanel>
                                    <Grid Grid.Row="2" Grid.Column="1" VerticalAlignment="Center">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <ComboBox Text="{Binding Buffer}" IsEditable="True">
                                            <ComboBoxItem Content="5"/>
                                            <ComboBoxItem Content="20"/>
                                            <ComboBoxItem Content="50"/>
                                            <ComboBoxItem Content="100"/>
                                            <ComboBoxItem Content="200"/>
                                            <ComboBoxItem Content="500"/>
                                            <ComboBoxItem Content="2000"/>
                                        </ComboBox>
                                        <TextBlock Grid.Column="1" Text="%" VerticalAlignment="Center" FontSize="14" Margin="10,0,0,0"/>
                                    </Grid>
                                </Grid>

                                <StackPanel Grid.Row="3" Grid.Column="0" VerticalAlignment="Center" Margin="0,15,30,0">
                                    <TextBlock Text="内存权重" FontSize="16" FontWeight="SemiBold"/>
                                    <TextBlock Text="主机内存不足时获得内存的优先级" Foreground="{DynamicResource TextFillColorSecondaryBrush}" FontSize="12" Margin="0,2,0,0" TextWrapping="Wrap"/>
                                </StackPanel>
                                <Grid Grid.Row="3" Grid.Column="1" VerticalAlignment="Center" Margin="0,15,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <Slider Value="{Binding Priority}" Minimum="0" Maximum="100" TickFrequency="10" IsSnapToTickEnabled="True" TickPlacement="BottomRight" VerticalAlignment="Center"/>
                                    <TextBlock Grid.Column="1" Text="{Binding Priority, StringFormat={}{0:F0}%}" Width="40" TextAlignment="Right" VerticalAlignment="Center" Margin="10,0,0,0"/>
                                </Grid>

                                <StackPanel Grid.Row="4" Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,25,0,0">
                                    <ui:Button Content="重置" Command="{Binding RevertChangesCommand}" Padding="20,8" MinWidth="100"/>
                                    <ui:Button Content="应用" Appearance="Primary" Margin="15,0,0,0" Command="{Binding SaveChangesCommand}" IsEnabled="{Binding IsDataValid}" Padding="20,8" MinWidth="100"/>
                                </StackPanel>
                            </Grid>
                        </ui:CardExpander>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

        </StackPanel>

        <ProgressBar Panel.ZIndex="1" VerticalAlignment="Top" Height="4" IsIndeterminate="True"
                     Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}"/>
    </Grid>
</Page>