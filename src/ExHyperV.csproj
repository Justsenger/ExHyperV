<Project Sdk="Microsoft.NET.Sdk">

    <!-- =================================================================== -->
    <!--                       1. 项目核心属性                               -->
    <!-- =================================================================== -->
    <PropertyGroup>
        <OutputType>WinExe</OutputType>
        <TargetFramework>net8.0-windows</TargetFramework>
        <UseWPF>true</UseWPF>
        <ImplicitUsings>enable</ImplicitUsings>
        <Nullable>enable</Nullable>
        <ApplicationIcon>applicationIcon.ico</ApplicationIcon>
        <Version>1.0.8</Version>
        <WpfUiGenerateDiagnosticMessages>False</WpfUiGenerateDiagnosticMessages>
        <SatelliteResourceLanguages>en;zh-Hans</SatelliteResourceLanguages>
        <DebugType Condition=" '$(Configuration)' == 'Release' ">none</DebugType>
        <DebugSymbols Condition=" '$(Configuration)' == 'Release' ">false</DebugSymbols>
    </PropertyGroup>

    <!-- =================================================================== -->
    <!--                       2. NuGet 包引用                               -->
    <!-- =================================================================== -->
    <ItemGroup>
        <PackageReference Include="CommunityToolkit.Mvvm" Version="8.4.0" />
        <PackageReference Include="Microsoft.PowerShell.SDK" Version="7.4.0" />
        <PackageReference Include="Microsoft.Xaml.Behaviors.Wpf" Version="1.1.135" />
        <PackageReference Include="TaskScheduler" Version="2.12.2" />
        <PackageReference Include="WPF-UI" Version="4.0.3" />
        <PackageReference Include="WPF-UI.Tray" Version="4.0.3" />
    </ItemGroup>

    <!-- =================================================================== -->
    <!--                       3. 资源文件定义                               -->
    <!-- =================================================================== -->
    <ItemGroup>
        <!-- 将 Assets 文件夹下的所有文件作为嵌入资源 -->
        <Resource Include="Assets\**\*.*" />
    </ItemGroup>

    <!-- =================================================================== -->
    <!--                       4. 自动生成文件配置                            -->
    <!-- =================================================================== -->
    <ItemGroup>
        <Compile Update="Properties\Resources.Designer.cs">
            <DesignTime>True</DesignTime>
            <AutoGen>True</AutoGen>
            <DependentUpon>Resources.resx</DependentUpon>
        </Compile>
        <EmbeddedResource Update="Properties\Resources.resx">
            <Generator>PublicResXFileCodeGenerator</Generator>
            <LastGenOutput>Resources.Designer.cs</LastGenOutput>
        </EmbeddedResource>
    </ItemGroup>

    <!-- ========================================================================================= -->
    <!-- ===                        ExHyperV 终极发布后清理脚本 (封神版)                         === -->
    <!-- ========================================================================================= -->
    <Target Name="GodTierCleanupAfterPublish" AfterTargets="Publish">
        <Message Text="========== Starting God-Tier Cleanup Script... ==========" Importance="high" />

        <!-- === 第1级: 绝对安全区 (100% Safe to Remove) === -->
        <ItemGroup>
            <SafeToRemove Include="$(PublishDir)Microsoft.CodeAnalysis*.dll" />
            <SafeToRemove Include="$(PublishDir)zh-Hans\Microsoft.CodeAnalysis*.resources.dll" />
            <SafeToRemove Include="$(PublishDir)**\*.pdb" />
        </ItemGroup>
        <RemoveDir Directories="$(PublishDir)ref" />
        <Delete Files="@(SafeToRemove)" />
        <Message Text="--- [Level 1: SAFE] Removed Roslyn, ref folder, and PDB files." Importance="high" />

        <!-- 清理多余的 runtimes 文件夹，仅保留 win 和 win-x64 -->
        <ItemGroup>
            <AllRuntimeDirs Include="$([System.IO.Directory]::GetDirectories('$(PublishDir)runtimes'))" />
            <RuntimeDirsToDelete Include="@(AllRuntimeDirs)" Condition=" '%(Filename)' != 'win' AND '%(Filename)' != 'win-x64' " />
        </ItemGroup>
        <RemoveDir Directories="@(RuntimeDirsToDelete)" />
        <Message Text="--- [Final Frontier] Cleaned up non-x64 runtimes." Importance="high" />

        <!-- === 第2级: 低风险区 (Low Risk) === -->
        <ItemGroup>
            <!-- 数据库支持 -->
            <LowRiskToRemove Include="$(PublishDir)System.Data.SqlClient.dll" />
            <LowRiskToRemove Include="$(PublishDir)runtimes\**\System.Data.SqlClient.dll" />
            <LowRiskToRemove Include="$(PublishDir)System.Data.OleDb.dll" />
            <LowRiskToRemove Include="$(PublishDir)runtimes\**\System.Data.OleDb.dll" />
            <LowRiskToRemove Include="$(PublishDir)System.Data.Odbc.dll" />
            <LowRiskToRemove Include="$(PublishDir)runtimes\**\System.Data.Odbc.dll" />
            <!-- Active Directory 支持 -->
            <LowRiskToRemove Include="$(PublishDir)System.DirectoryServices.AccountManagement.dll" />
            <LowRiskToRemove Include="$(PublishDir)runtimes\**\System.DirectoryServices.AccountManagement.dll" />
            <LowRiskToRemove Include="$(PublishDir)System.DirectoryServices.Protocols.dll" />
            <LowRiskToRemove Include="$(PublishDir)runtimes\**\System.DirectoryServices.Protocols.dll" />
            <!-- 其他边缘功能 -->
            <LowRiskToRemove Include="$(PublishDir)System.Speech.dll" />
            <LowRiskToRemove Include="$(PublishDir)runtimes\**\System.Speech.dll" />
            <LowRiskToRemove Include="$(PublishDir)System.Web.Services.Description.dll" />
            <LowRiskToRemove Include="$(PublishDir)zh-Hans\System.Web.Services.Description.resources.dll" />
            <LowRiskToRemove Include="$(PublishDir)System.ServiceModel.Syndication.dll" />
            <LowRiskToRemove Include="$(PublishDir)JsonSchema.Net.dll" />
            <LowRiskToRemove Include="$(PublishDir)Json.More.dll" />
            <LowRiskToRemove Include="$(PublishDir)JsonPointer.Net.dll" />
        </ItemGroup>
        <Delete Files="@(LowRiskToRemove)" />
        <Message Text="--- [Level 2: LOW RISK] Removed Database, AD, and other optional modules." Importance="high" />

        <!-- === 第3级: 中风险区 (Medium Risk) === -->
        <ItemGroup>
            <!-- Windows 服务和事件日志管理 -->
            <MediumRiskToRemove Include="$(PublishDir)System.ServiceProcess.ServiceController.dll" />
            <MediumRiskToRemove Include="$(PublishDir)runtimes\**\System.ServiceProcess.ServiceController.dll" />
            <MediumRiskToRemove Include="$(PublishDir)System.Diagnostics.EventLog.dll" />
            <MediumRiskToRemove Include="$(PublishDir)runtimes\**\System.Diagnostics.EventLog.dll" />
            <!-- Markdown 渲染 (用于富文本帮助信息) -->
            <MediumRiskToRemove Include="$(PublishDir)Markdig.Signed.dll" />
            <!-- 新增: GDI+ 图形库、核心窗口库和系统事件 -->
            <MediumRiskToRemove Include="$(PublishDir)System.Drawing.Common.dll" />
            <MediumRiskToRemove Include="$(PublishDir)runtimes\**\System.Drawing.Common.dll" />
            <MediumRiskToRemove Include="$(PublishDir)System.Private.Windows.Core.dll" />
            <MediumRiskToRemove Include="$(PublishDir)Microsoft.Win32.SystemEvents.dll" />
            <MediumRiskToRemove Include="$(PublishDir)runtimes\**\Microsoft.Win32.SystemEvents.dll" />
        </ItemGroup>
        <Delete Files="@(MediumRiskToRemove)" />
        <Message Text="--- [Level 3: MEDIUM RISK] Removed Service/EventLog, Markdig, Drawing, and SystemEvents." Importance="high" />

        <!-- === 第4级: 高风险区 (High Risk) === -->
        <ItemGroup>
            <HighRiskToRemove Include="$(PublishDir)System.Private.ServiceModel.dll" />
            <HighRiskToRemove Include="$(PublishDir)zh-Hans\System.Private.ServiceModel.resources.dll" />
        </ItemGroup>
        <Delete Files="@(HighRiskToRemove)" />
        <Message Text="--- [Level 4: HIGH RISK] Removed ServiceModel (WCF). Remoting is disabled." Importance="high" />

        <!-- === 最终魔法: 从 dll 文件夹复制优化版 DLL 进行替换 === -->
        <ItemGroup>
            <MagicDlls Include="$(MSBuildProjectDirectory)\dll\*.dll" />
        </ItemGroup>
        <Copy SourceFiles="@(MagicDlls)" DestinationFolder="$(PublishDir)" OverwriteReadOnlyFiles="true" SkipUnchangedFiles="false" />
        <Message Text="--- (Magic) Replaced official DLLs with God-Tier versions from dll folder." Importance="high" />

        <Message Text="========== God-Tier Cleanup Script Finished. ==========" Importance="high" />
    </Target>

</Project>