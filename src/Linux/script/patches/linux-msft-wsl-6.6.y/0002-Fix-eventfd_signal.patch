From: Justsenger <Justsenger@users.noreply.github.com>
Date: Tue, 21 Jan 2025 15:00:00 +0800
Subject: [PATCH] dxgkrnl: Unified compatibility fixes (Fixed line counts)

Signed-off-by: Justsenger <Justsenger@users.noreply.github.com>
---
 drivers/hv/dxgkrnl/dxgadapter.c  |  1 +
 drivers/hv/dxgkrnl/dxgkrnl.h     |  1 +
 drivers/hv/dxgkrnl/dxgmodule.c   |  6 +++++-
 drivers/hv/dxgkrnl/dxgsyncfile.c | 13 ++++++++++++--
 drivers/hv/dxgkrnl/dxgvmbus.c    | 12 ++++++++++--
 drivers/hv/dxgkrnl/hmgr.c        |  1 +
 drivers/hv/dxgkrnl/ioctl.c       |  1 +
 7 files changed, 35 insertions(+), 5 deletions(-)

diff --git a/drivers/hv/dxgkrnl/dxgadapter.c b/drivers/hv/dxgkrnl/dxgadapter.c
index 6d3cabb..0844ef0 100644
--- a/drivers/hv/dxgkrnl/dxgadapter.c
+++ b/drivers/hv/dxgkrnl/dxgadapter.c
@@ -17,0 +18 @@
+#include <linux/vmalloc.h>
diff --git a/drivers/hv/dxgkrnl/dxgkrnl.h b/drivers/hv/dxgkrnl/dxgkrnl.h
index 1234567..89abcdef 100644
--- a/drivers/hv/dxgkrnl/dxgkrnl.h
+++ b/drivers/hv/dxgkrnl/dxgkrnl.h
@@ -18,0 +19 @@
+#include <linux/version.h>
diff --git a/drivers/hv/dxgkrnl/dxgmodule.c b/drivers/hv/dxgkrnl/dxgmodule.c
index 1501e0a..d8941db 100644
--- a/drivers/hv/dxgkrnl/dxgmodule.c
+++ b/drivers/hv/dxgkrnl/dxgmodule.c
@@ -173 +173,5 @@ void signal_host_cpu_event(struct dxghostevent *eventhdr)
-		eventfd_signal(event->cpu_event, 1);
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 8, 0)
+		eventfd_signal(event->cpu_event);
+#else
+		eventfd_signal(event->cpu_event, 1);
+#endif
diff --git a/drivers/hv/dxgkrnl/dxgsyncfile.c b/drivers/hv/dxgkrnl/dxgsyncfile.c
index 3456789..9876543 100644
--- a/drivers/hv/dxgkrnl/dxgsyncfile.c
+++ b/drivers/hv/dxgkrnl/dxgsyncfile.c
@@ -13,0 +14 @@
+#include <linux/version.h>
@@ -441,2 +442,5 @@ static bool dxgdmafence_signaled(struct dma_fence *fence)
-	return __dma_fence_is_later(syncpoint->fence_value, fence->seqno,
-				    fence->ops);
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 10, 0)
+	return __dma_fence_is_later(fence, syncpoint->fence_value, fence->seqno);
+#else
+	return __dma_fence_is_later(syncpoint->fence_value, fence->seqno, fence->ops);
+#endif
 }
@@ -448,0 +452,2 @@ static bool dxgdmafence_enable_signaling(struct dma_fence *fence)
+#if LINUX_VERSION_CODE < KERNEL_VERSION(6, 4, 0)
+/* Removed in kernel 6.4 */
@@ -458,0 +464,2 @@ static void dxgdmafence_timeline_value_str(struct dma_fence *fence,
+#endif
+
@@ -465,2 +473,4 @@ static const struct dma_fence_ops dxgdmafence_ops = {
+#if LINUX_VERSION_CODE < KERNEL_VERSION(6, 4, 0)
 	.fence_value_str = dxgdmafence_value_str,
 	.timeline_value_str = dxgdmafence_timeline_value_str,
+#endif
diff --git a/drivers/hv/dxgkrnl/dxgvmbus.c b/drivers/hv/dxgkrnl/dxgvmbus.c
index abb6d2a..f04240d 100644
--- a/drivers/hv/dxgkrnl/dxgvmbus.c
+++ b/drivers/hv/dxgkrnl/dxgvmbus.c
@@ -22,0 +23 @@
+#include <linux/vmalloc.h>
@@ -603 +604 @@ static u8 *dxg_map_iospace(u64 iospace_address, u32 size,
-	mmap_read_lock(current->mm);
+	mmap_write_lock(current->mm);
@@ -621 +622 @@ static u8 *dxg_map_iospace(u64 iospace_address, u32 size,
-	mmap_read_unlock(current->mm);
+	mmap_write_unlock(current->mm);
@@ -693 +694,5 @@ int dxgvmb_send_create_process(struct dxgprocess *process)
-	__get_task_comm(s, WIN_MAX_PATH, current);
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(6, 1, 0)
+	strscpy(s, current->comm, WIN_MAX_PATH);
+#else
+	__get_task_comm(s, WIN_MAX_PATH, current);
+#endif
diff --git a/drivers/hv/dxgkrnl/hmgr.c b/drivers/hv/dxgkrnl/hmgr.c
index 24101d0..528402a 100644
--- a/drivers/hv/dxgkrnl/hmgr.c
+++ b/drivers/hv/dxgkrnl/hmgr.c
@@ -16,0 +17 @@
+#include <linux/vmalloc.h>
diff --git a/drivers/hv/dxgkrnl/ioctl.c b/drivers/hv/dxgkrnl/ioctl.c
index 42f3de3..d70a4b9 100644
--- a/drivers/hv/dxgkrnl/ioctl.c
+++ b/drivers/hv/dxgkrnl/ioctl.c
@@ -19,0 +20 @@
+#include <linux/vmalloc.h>
--