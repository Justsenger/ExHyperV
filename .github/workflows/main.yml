name: Update Image Manifest

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get install -y jq curl

      - name: Setup Environment
        run: |
          # 1. 强力伪造 quickemu 并放入系统路径，彻底解决 "not found"
          echo '#!/bin/bash' | sudo tee /usr/local/bin/quickemu
          echo 'echo "4.9.6"' | sudo tee -a /usr/local/bin/quickemu
          sudo chmod +x /usr/local/bin/quickemu
          
          # 2. 下载 quickget
          curl -LO https://raw.githubusercontent.com/quickemu-project/quickemu/master/quickget
          chmod +x quickget

      - name: Generate JSON with URLs
        run: |
          # 获取基础 CSV 列表
          ./quickget --list-csv > raw.csv
          
          # 创建结果文件头
          echo "DisplayName,OS,Release,Option,DownloadURL,Logo" > final.csv
          
          # 遍历抓取链接 (为了演示速度，先抓取前 50 个，如果想抓全部，去掉 head -n 50)
          # 注意：跳过标题行
          tail -n +2 raw.csv | head -n 50 | while IFS=, read -r name os rel opt dl png svg; do
            echo "Fetching URL for $name $rel $opt..."
            
            # 只有 Linux 系统尝试获取实时链接，Windows/macOS 标记为 DYNAMIC
            if [[ "$os" == "windows"* ]] || [[ "$os" == "macos" ]]; then
              URL="DYNAMIC_LINK"
            else
              # 尝试获取 URL，超时时间设为 10 秒防止死锁
              URL=$(timeout 10s ./quickget "$os" "$rel" "$opt" --url 2>/dev/null | grep -E '^https?://' | head -n 1 || echo "MANUAL_CHECK")
            fi
            
            echo "$name,$os,$rel,$opt,$URL,$png" >> final.csv
          done

          # 转换为 JSON
          jq -R -s '
            split("\n") | .[1:-1] | map(split(",")) | map(select(length >= 6)) | map({
              "DisplayName": .[0],
              "OS": .[1],
              "Release": .[2],
              "Option": .[3],
              "DownloadURL": .[4],
              "Logo": .[5]
            })
          ' final.csv > images.json

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add images.json
          git commit -m "Update images.json with dynamic URLs" || exit 0
          git push
